- name: Determine serial value based on install variable
  hosts: localhost_group
  gather_facts: no
  tasks:
    - name: Set serial value for cluster nodes
      set_fact:
        serial_value: "{{ '1' if (install | default(false) | bool == false) else '100%' }}"
  tags:
  - always

- name: Build new_nodes group dynamically
  hosts: localhost_group
  gather_facts: no
  tags:
    - always
  tasks:
    - name: Add worker hosts that have new_node=true to runtime group new_nodes
      add_host:
        name: "{{ item }}"
        groups: new_nodes
        ansible_host: "{{ hostvars[item].ansible_host | default(omit) }}"
      loop: "{{ groups['worker'] }}"
      when: hostvars[item].new_node | default(false) | bool
      run_once: true

    - name: Show members of new_nodes (runtime)
      debug:
        var: groups['new_nodes']
      run_once: true

- name: Base tools preparation
  become: yes
  gather_facts: no
  hosts: controller
  roles:
    - pre
  tags:
    - pre

- name: Generate configs
  become: yes
  gather_facts: no
  hosts: localhost_group
  roles:
    - config
  tags:
    - config

- name: Setup etcd cluster
  become: yes
  gather_facts: no
  hosts: etcd
  roles:
    - etcd
  tags:
    - etcd

- name: Setup worker nodes
  gather_facts: no
  become: yes
  hosts: "{{ 'new_nodes' if add_new_node | default(false) else 'worker' }}"
  roles:
    - worker
  serial: "{{ hostvars['localhost'].serial_value }}"
  tags:
    - worker

- name: Setup controller cluster
  gather_facts: no
  become: yes
  hosts: controller
  roles:
    - controller
  serial: "{{ hostvars['localhost'].serial_value }}"
  tags:
    - controller

- name: Setup calio CNI & coredns service discovery & ingress-controller & storageClass
  gather_facts: no
  become: yes
  hosts: controller
  roles:
    - addons
  tags:
    - addons
